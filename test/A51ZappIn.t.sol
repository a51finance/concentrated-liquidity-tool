//SPDX-License-Identifier: MIT
pragma solidity =0.8.15;

import "forge-std/Test.sol";
import "../src/CLTZappIn.sol";
import "../src/interfaces/ICLTBase.sol";
import { IUniswapV3Pool } from "@uniswap/v3-core/contracts/interfaces/IUniswapV3Pool.sol";
import { ERC20 } from "solmate/tokens/ERC20.sol";
import "forge-std/console.sol";
import "../src/interfaces/external/IWETH9.sol";

contract A51ZappInTest is Test {
    // A51ZappIn zapIn;
    // ERC20 constant token0 = ERC20(0xaf88d065e77c8cC2239327C5EDb3A432268e5831); //USDC
    // ERC20 constant token1 = ERC20(0xFd086bC7CD5C481DCC9C85ebE478A1C0b69FCbb9);
    // ERC20 constant token2 = ERC20(0xDA10009cBd5D07dd0CeCc66161FC93D7c9000da1); //DAI

    ERC20 constant token0 = ERC20(0x2f2a2543B76A4166549F7aaB2e75Bef0aefC5B0f); //WBTC
    ERC20 constant token1 = ERC20(0x82aF49447D8a07e3bd95BD0d56f35241523fBab1);

    IWETH9 constant weth = IWETH9(0x82aF49447D8a07e3bd95BD0d56f35241523fBab1);
    address cltBase = 0x3e0AA2e17FE3E5e319f388C794FdBC3c64Ef9da6;
    address tokenApprover = 0x70cBb871E8f30Fc8Ce23609E9E0Ea87B6b222F58;
    CLTZappIn zapIn = CLTZappIn(0xE2331F5EF9B6D5B1f4921c19ce357105bCaDBe38);
    IUniswapV3Pool constant uniswapPool = IUniswapV3Pool(0xbE3aD6a5669Dc0B8b12FeBC03608860C31E2eef6);
    IUniswapV3Pool constant uniswapPool2 = IUniswapV3Pool(0xC6962004f452bE9203591991D15f6b388e09E8D0); //ETH-USDC
    bytes32 strategyID = 0x4fa677272f9c7c30913c6c388ffc13912b19e21592867194c2f69e022d1760c3;
    bytes32 strategyID2 = 0x574712806f505493ea90acd4a2073b4daccde2a392dc97fa363ad477d0ea841d; //ETH-USDC

    function setUp() public {
        // zapIn = new CLTZappIn({
        //     okxProxy: 0xf332761c673b59B21fF6dfa8adA44d78c12dEF09,
        //     cltBase: ICLTBase(cltBase),
        //     tokenApprover: tokenApprover,
        //     weth: weth
        // });
        // console.log("ZapIn Address", address(zapIn));
    }

    function approveToken(uint256 amount, ERC20 token, address to) internal {
        token.approve(to, amount);
    }

    function test_basicAdd() external {
        uint256 amount0Desired = 1e18;
        uint256 amount1Desired = 1.77e18;

        // mint tokens
        deal(address(token0), address(this), amount0Desired);
        deal(address(token1), address(this), amount1Desired);

        console.log("Token0 Allowance Before", token0.allowance(address(zapIn), address(cltBase)));
        console.log("Token1 Allowance Before", token1.allowance(address(zapIn), address(cltBase)));

        (uint256 shares,,,) = zapIn.zapIn(
            ICLTBase.DepositParams({
                strategyId: strategyID,
                amount0Desired: amount0Desired,
                amount1Desired: amount1Desired,
                amount0Min: 0,
                amount1Min: 0,
                recipient: address(this)
            }),
            token0,
            token1,
            false,
            false
        );

        console.log("Token0 Allowance After", token0.allowance(address(zapIn), address(cltBase)));
        console.log("Token1 Allowance After", token1.allowance(address(zapIn), address(cltBase)));

        assertGt(shares, 0, "shares are zero");
        assertEq(token0.balanceOf(address(zapIn)), 0, "zap has token0 balance");
        assertEq(token1.balanceOf(address(zapIn)), 0, "zap has token1 balance");
    }

    function test_multicall_wrapEthAndZap() external {
        uint256 amount0Desired = 1e18; // WETH
        uint256 amount1Desired = 3500e6; // USDC

        // mint tokens
        deal(address(token0), address(this), amount1Desired);
        token0.approve(address(zapIn), amount1Desired);

        // make multicall
        bytes[] memory calls = new bytes[](2);
        calls[0] = abi.encodeWithSelector(zapIn.wrapEthInput.selector);

        calls[1] = abi.encodeWithSelector(
            zapIn.zapIn.selector,
            ICLTBase.DepositParams({
                strategyId: strategyID2,
                amount0Desired: amount0Desired,
                amount1Desired: amount1Desired,
                amount0Min: 0,
                amount1Min: 0,
                recipient: address(this)
            }),
            uniswapPool2.token0(),
            uniswapPool2.token1(),
            true,
            false
        );

        bytes[] memory results = zapIn.multicall{ value: 1 ether }(calls);
        (uint256 shares,,,) = abi.decode(results[1], (uint256, uint128, uint256, uint256));

        assertGt(shares, 0, "shares is zero");
        assertEq(weth.balanceOf(address(zapIn)), 0, "zap has token0 balance");
        assertEq(token0.balanceOf(address(zapIn)), 0, "zap has token1 balance");
    }

    function test__multicallSwap__zappIn() public {
        uint256 totalAmount0 = 1e8;
        uint256 amount0Desired = totalAmount0 / 2;

        // deal(address(token0), address(this), totalAmount0);
        vm.prank(0xa0e9E6B79a3e1AB87FeB209567eF3E0373210a89);
        token0.approve(address(zapIn), totalAmount0);
        console.log(token0.allowance(address(0xa0e9E6B79a3e1AB87FeB209567eF3E0373210a89), address(zapIn)));
        console.log(token0.balanceOf(address(0xa0e9E6B79a3e1AB87FeB209567eF3E0373210a89)));

        bytes[] memory calls = new bytes[](2);
        calls[0] = abi.encodeWithSelector(
            zapIn.doZeroExSwap.selector,
            address(token0),
            amount0Desired,
            address(token1),
            10_894_206_511_233_801_685,
            address(zapIn),
            address(0xa0e9E6B79a3e1AB87FeB209567eF3E0373210a89),
            false,
            block.timestamp + 1 days,
            hex"b80c2f09000000000000000000000000000000000000000000000000000000000001901b0000000000000000000000002f2a2543b76a4166549f7aab2e75bef0aefc5b0f00000000000000000000000082af49447d8a07e3bd95bd0d56f35241523fbab10000000000000000000000000000000000000000000000000000000002faf080000000000000000000000000000000000000000000000000972fff1a1bd69dd50000000000000000000000000000000000000000000000000000000066c5c66f00000000000000000000000000000000000000000000000000000000000001200000000000000000000000000000000000000000000000000000000000000160000000000000000000000000000000000000000000000000000000000000072000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000002faf080000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000012000000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000002200000000000000000000000002f2a2543b76a4166549f7aab2e75bef0aefc5b0f0000000000000000000000000000000000000000000000000000000000000003000000000000000000000000443ef018e182d409bcf7f794d409bcea4c73c2c7000000000000000000000000bd4991108f931da96f5b4d7cd39d5c8e558a0d2d000000000000000000000000a0d62be88fa3e42b607b8252d828df6dfcd3dbe10000000000000000000000000000000000000000000000000000000000000003000000000000000000000000443ef018e182d409bcf7f794d409bcea4c73c2c7000000000000000000000000bd4991108f931da96f5b4d7cd39d5c8e558a0d2d000000000000000000000000a0d62be88fa3e42b607b8252d828df6dfcd3dbe100000000000000000000000000000000000000000000000000000000000000030000000000000000000024b82f5e87c9312fa29aed5c179e456625d79015299c0000000000000000000001902760cc828b2e4d04f8ec261a5335426bb22d92910000000000000000000000c84bfc22a4da7f31f8a912a79a7e44a822398b4390000000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000140000000000000000000000000000000000000000000000000000000000000022000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000600000000000000000000000002f2a2543b76a4166549f7aab2e75bef0aefc5b0f00000000000000000000000082af49447d8a07e3bd95bd0d56f35241523fbab100000000000000000000000000000000000000000000000000000000000001f400000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000600000000000000000000000002f2a2543b76a4166549f7aab2e75bef0aefc5b0f00000000000000000000000082af49447d8a07e3bd95bd0d56f35241523fbab1000000000000000000000000000000000000000000000000000000000000019000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000600000000000000000000000002f2a2543b76a4166549f7aab2e75bef0aefc5b0f00000000000000000000000082af49447d8a07e3bd95bd0d56f35241523fbab100000000000000000000000000000000000000000000000000000000000000640000000000000000000000000000000000000000000000000000000000000000"
        );

        calls[1] = abi.encodeWithSelector(
            zapIn.zapIn.selector,
            ICLTBase.DepositParams({
                strategyId: strategyID,
                amount0Desired: amount0Desired,
                amount1Desired: 10e18, // amount1 to be fetched by ratio
                amount0Min: 0,
                amount1Min: 0,
                recipient: address(0xa0e9E6B79a3e1AB87FeB209567eF3E0373210a89)
            }),
            token0,
            token1,
            false,
            true
        );
        vm.prank(0xa0e9E6B79a3e1AB87FeB209567eF3E0373210a89);

        console.logBytes(calls[0]);
        console.logBytes(calls[1]);

        bytes[] memory results = zapIn.multicall(calls);

        (uint256 shares,,,) = abi.decode(results[1], (uint256, uint128, uint256, uint256));
        assertEq(token0.balanceOf(address(zapIn)), 0);
        assertEq(token1.balanceOf(address(zapIn)), 0);
    }

    function test__multicall__wrapETH__Swap__zappIn() public {
        uint256 totalAmount0 = 5e18;
        uint256 amount0Desired = totalAmount0 / 2;
        uint256 amount1Desired = 2.5 * 3500e6;

        bytes[] memory calls = new bytes[](3);

        calls[0] = abi.encodeWithSelector(zapIn.wrapEthInput.selector);

        calls[1] = abi.encodeWithSelector(
            zapIn.doZeroExSwap.selector,
            address(weth), // tokenIn
            amount0Desired,
            address(token0),
            8_238_895_296,
            address(zapIn),
            address(zapIn),
            true,
            block.timestamp + 1 days,
            hex"b80c2f09000000000000000000000000000000000000000000000000000000000001901b0000000000000000000000002f2a2543b76a4166549f7aab2e75bef0aefc5b0f00000000000000000000000082af49447d8a07e3bd95bd0d56f35241523fbab10000000000000000000000000000000000000000000000000000000002faf080000000000000000000000000000000000000000000000000977a101184d886e70000000000000000000000000000000000000000000000000000000066c5bf07000000000000000000000000000000000000000000000000000000000000012000000000000000000000000000000000000000000000000000000000000001a0000000000000000000000000000000000000000000000000000000000000238000000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000002160ec0000000000000000000000000000000000000000000000000000000000098968000000000000000000000000000000000000000000000000000000000004c4b400000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000005c000000000000000000000000000000000000000000000000000000000000015800000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000012000000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000002200000000000000000000000002f2a2543b76a4166549f7aab2e75bef0aefc5b0f00000000000000000000000000000000000000000000000000000000000000030000000000000000000000004e3bcce28caf98a143fd8bd9e4875ccab3e7bbe0000000000000000000000000bd4991108f931da96f5b4d7cd39d5c8e558a0d2d000000000000000000000000a0d62be88fa3e42b607b8252d828df6dfcd3dbe100000000000000000000000000000000000000000000000000000000000000030000000000000000000000004e3bcce28caf98a143fd8bd9e4875ccab3e7bbe0000000000000000000000000bd4991108f931da96f5b4d7cd39d5c8e558a0d2d000000000000000000000000a0d62be88fa3e42b607b8252d828df6dfcd3dbe10000000000000000000000000000000000000000000000000000000000000003000000000000000000001e78d845f7d4f4deb9ff5bcf09d140ef13718f6f6c710000000000000000000005782760cc828b2e4d04f8ec261a5335426bb22d92910000000000000000000003204bfc22a4da7f31f8a912a79a7e44a822398b4390000000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000120000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000400000000000000000000000002f2a2543b76a4166549f7aab2e75bef0aefc5b0f00000000000000000000000082af49447d8a07e3bd95bd0d56f35241523fbab100000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000600000000000000000000000002f2a2543b76a4166549f7aab2e75bef0aefc5b0f00000000000000000000000082af49447d8a07e3bd95bd0d56f35241523fbab1000000000000000000000000000000000000000000000000000000000000012c00000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000600000000000000000000000002f2a2543b76a4166549f7aab2e75bef0aefc5b0f00000000000000000000000082af49447d8a07e3bd95bd0d56f35241523fbab10000000000000000000000000000000000000000000000000000000000000064000000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000520000000000000000000000000000000000000000000000000000000000000092000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000012000000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000002200000000000000000000000002f2a2543b76a4166549f7aab2e75bef0aefc5b0f0000000000000000000000000000000000000000000000000000000000000003000000000000000000000000443ef018e182d409bcf7f794d409bcea4c73c2c7000000000000000000000000443ef018e182d409bcf7f794d409bcea4c73c2c7000000000000000000000000b0cb12d5783617728b2dc79b8a75f99c1fcbe6180000000000000000000000000000000000000000000000000000000000000003000000000000000000000000443ef018e182d409bcf7f794d409bcea4c73c2c7000000000000000000000000443ef018e182d409bcf7f794d409bcea4c73c2c7000000000000000000000000b0cb12d5783617728b2dc79b8a75f99c1fcbe61800000000000000000000000000000000000000000000000000000000000000030000000000000000000012c05969efdde3cf5c0d9a88ae51e47d721096a97203000000000000000000000c8053c6ca2597711ca7a73b6921faf4031eedf713390000000000000000000007d0ed9e3f98bbed560e66b89aac922e29d4596a9642000000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000140000000000000000000000000000000000000000000000000000000000000022000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000600000000000000000000000002f2a2543b76a4166549f7aab2e75bef0aefc5b0f000000000000000000000000fd086bc7cd5c481dcc9c85ebe478a1c0b69fcbb900000000000000000000000000000000000000000000000000000000000001f400000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000600000000000000000000000002f2a2543b76a4166549f7aab2e75bef0aefc5b0f000000000000000000000000fd086bc7cd5c481dcc9c85ebe478a1c0b69fcbb90000000000000000000000000000000000000000000000000000000000000bb800000000000000000000000000000000000000000000000000000000000000400000000000000000000000002f2a2543b76a4166549f7aab2e75bef0aefc5b0f000000000000000000000000fd086bc7cd5c481dcc9c85ebe478a1c0b69fcbb900000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000012000000000000000000000000000000000000000000000000000000000000001a00000000000000000000000000000000000000000000000000000000000000220000000000000000000000000fd086bc7cd5c481dcc9c85ebe478a1c0b69fcbb9000000000000000000000000000000000000000000000000000000000000000300000000000000000000000047b5bc2c49ad25dfa6d7363c5e9b28ef804e11850000000000000000000000002fa31d2ac017869998f9574bac76094a8110cf7c0000000000000000000000006667c8dc9fbfec411e7c1ee2b24de960149f930f00000000000000000000000000000000000000000000000000000000000000030000000000000000000000002e50e3e18c19c7d80b81888a961a13aee49b962e0000000000000000000000002fa31d2ac017869998f9574bac76094a8110cf7c000000000000000000000000fc43aaf89a71acaa644842ee4219e8eb7765742700000000000000000000000000000000000000000000000000000000000000030000000000000000000024b82e50e3e18c19c7d80b81888a961a13aee49b962e800000000000000000000190cc065eb6460272481216757293ffc54a061ba60e8000000000000000000000c8fc43aaf89a71acaa644842ee4219e8eb776574270000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000001800000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000060000000000000000000000000fd086bc7cd5c481dcc9c85ebe478a1c0b69fcbb9000000000000000000000000af88d065e77c8cc2239327c5edb3a432268e583100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000001e00000000000000000000000000000000000000000000000000000000000000280000000000000000000000000af88d065e77c8cc2239327c5edb3a432268e583100000000000000000000000000000000000000000000000000000000000000040000000000000000000000004e3bcce28caf98a143fd8bd9e4875ccab3e7bbe0000000000000000000000000443ef018e182d409bcf7f794d409bcea4c73c2c7000000000000000000000000a0d62be88fa3e42b607b8252d828df6dfcd3dbe1000000000000000000000000443ef018e182d409bcf7f794d409bcea4c73c2c700000000000000000000000000000000000000000000000000000000000000040000000000000000000000004e3bcce28caf98a143fd8bd9e4875ccab3e7bbe0000000000000000000000000443ef018e182d409bcf7f794d409bcea4c73c2c7000000000000000000000000a0d62be88fa3e42b607b8252d828df6dfcd3dbe1000000000000000000000000443ef018e182d409bcf7f794d409bcea4c73c2c70000000000000000000000000000000000000000000000000000000000000004800000000000000000001f40b1026b8e7276e7ac75410f1fcbbe21796e8f75268000000000000000000004b0b658ee5c63922d2852f24458effa2bfa2cba35748000000000000000000002587fcdc35463e3770c2fb992716cd070b63540b9478000000000000000000000c86f38e884725a116c9c7fbf208e79fe8828a2595f0000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000001400000000000000000000000000000000000000000000000000000000000000220000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000040000000000000000000000000af88d065e77c8cc2239327c5edb3a432268e583100000000000000000000000082af49447d8a07e3bd95bd0d56f35241523fbab100000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000060000000000000000000000000af88d065e77c8cc2239327c5edb3a432268e583100000000000000000000000082af49447d8a07e3bd95bd0d56f35241523fbab1000000000000000000000000000000000000000000000000000000000000006400000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000060000000000000000000000000af88d065e77c8cc2239327c5edb3a432268e583100000000000000000000000082af49447d8a07e3bd95bd0d56f35241523fbab1000000000000000000000000000000000000000000000000000000000000006400000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000060000000000000000000000000af88d065e77c8cc2239327c5edb3a432268e583100000000000000000000000082af49447d8a07e3bd95bd0d56f35241523fbab100000000000000000000000000000000000000000000000000000000000000640000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000003c000000000000000000000000000000000000000000000000000000000000005a000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000001c00000000000000000000000002f2a2543b76a4166549f7aab2e75bef0aefc5b0f0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000b0cb12d5783617728b2dc79b8a75f99c1fcbe618000000000000000000000000443ef018e182d409bcf7f794d409bcea4c73c2c70000000000000000000000000000000000000000000000000000000000000002000000000000000000000000b0cb12d5783617728b2dc79b8a75f99c1fcbe618000000000000000000000000443ef018e182d409bcf7f794d409bcea4c73c2c70000000000000000000000000000000000000000000000000000000000000002000000000000000000002008ed9e3f98bbed560e66b89aac922e29d4596a9642000000000000000000000708ac70bd92f89e6739b3a08db9b6081a923912f73d0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000400000000000000000000000002f2a2543b76a4166549f7aab2e75bef0aefc5b0f000000000000000000000000ff970a61a04b1ca14834a43f5de4533ebddb5cc800000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000600000000000000000000000002f2a2543b76a4166549f7aab2e75bef0aefc5b0f000000000000000000000000ff970a61a04b1ca14834a43f5de4533ebddb5cc800000000000000000000000000000000000000000000000000000000000001f400000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000001200000000000000000000000000000000000000000000000000000000000000160000000000000000000000000ff970a61a04b1ca14834a43f5de4533ebddb5cc800000000000000000000000000000000000000000000000000000000000000010000000000000000000000001c8875b6a9df43256b244a7ba4790f6a7185d8c900000000000000000000000000000000000000000000000000000000000000010000000000000000000000001c8875b6a9df43256b244a7ba4790f6a7185d8c90000000000000000000000000000000000000000000000000000000000000001800000000000000000002710e4b2dfc82977dd2dce7e8d37895a6a8f50cbb4fb000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000001e00000000000000000000000000000000000000000000000000000000000000280000000000000000000000000fd086bc7cd5c481dcc9c85ebe478a1c0b69fcbb900000000000000000000000000000000000000000000000000000000000000040000000000000000000000004e3bcce28caf98a143fd8bd9e4875ccab3e7bbe0000000000000000000000000a0d62be88fa3e42b607b8252d828df6dfcd3dbe1000000000000000000000000a0d62be88fa3e42b607b8252d828df6dfcd3dbe1000000000000000000000000443ef018e182d409bcf7f794d409bcea4c73c2c700000000000000000000000000000000000000000000000000000000000000040000000000000000000000004e3bcce28caf98a143fd8bd9e4875ccab3e7bbe0000000000000000000000000a0d62be88fa3e42b607b8252d828df6dfcd3dbe1000000000000000000000000a0d62be88fa3e42b607b8252d828df6dfcd3dbe1000000000000000000000000443ef018e182d409bcf7f794d409bcea4c73c2c700000000000000000000000000000000000000000000000000000000000000048000000000000000000011307cccba38e2d959fe135e79aebb57ccb27b128358800000000000000000000e10389938cf14be379217570d8e4619e51fbdafaa218000000000000000000003e80bacc7a9717e70ea0da5ac075889bd87d4c811978000000000000000000003e8641c00a822e8b671738d32a431a4fb6074e5c79d0000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000001400000000000000000000000000000000000000000000000000000000000000220000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000040000000000000000000000000fd086bc7cd5c481dcc9c85ebe478a1c0b69fcbb900000000000000000000000082af49447d8a07e3bd95bd0d56f35241523fbab100000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000060000000000000000000000000fd086bc7cd5c481dcc9c85ebe478a1c0b69fcbb900000000000000000000000082af49447d8a07e3bd95bd0d56f35241523fbab1000000000000000000000000000000000000000000000000000000000000006400000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000060000000000000000000000000fd086bc7cd5c481dcc9c85ebe478a1c0b69fcbb900000000000000000000000082af49447d8a07e3bd95bd0d56f35241523fbab100000000000000000000000000000000000000000000000000000000000001f400000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000060000000000000000000000000fd086bc7cd5c481dcc9c85ebe478a1c0b69fcbb900000000000000000000000082af49447d8a07e3bd95bd0d56f35241523fbab100000000000000000000000000000000000000000000000000000000000001f40000000000000000000000000000000000000000000000000000000000000000"
        );

        calls[2] = abi.encodeWithSelector(
            zapIn.zapIn.selector,
            ICLTBase.DepositParams({
                strategyId: strategyID2,
                amount0Desired: amount0Desired,
                amount1Desired: amount1Desired, // amount1 to be fetched by ratio
                amount0Min: 0,
                amount1Min: 0,
                recipient: address(this)
            }),
            weth,
            token0,
            true,
            true
        );

        console.logBytes(calls[0]);
        console.logBytes(calls[1]);
        console.logBytes(calls[2]);

        bytes[] memory results = zapIn.multicall{ value: 5 ether }(calls);

        (uint256 shares,,,) = abi.decode(results[2], (uint256, uint128, uint256, uint256));
        assertGt(shares, 0, "shares is zero");
        assertEq(token0.balanceOf(address(zapIn)), 0);
        assertEq(token1.balanceOf(address(zapIn)), 0);
    }
    // Avoid Swapping from a third token
    /**
     * function test__multicallSwap__zappIn__thirdToken() public {
     *     uint256 thirdTokenAmount = 90e18;
     *     uint256 amount0Desired = 43e6;
     *     uint256 amount1Desired = 43e6;
     *
     *     deal(address(token2), address(this), thirdTokenAmount);
     *     token2.approve(address(zapIn), type(uint256).max);
     *     token2.approve(address(0xf332761c673b59B21fF6dfa8adA44d78c12dEF09), type(uint256).max);
     *
     *     bytes[] memory calls = new bytes[](3);
     *
     *     // swap token0 from token2
     *     calls[0] = abi.encodeWithSelector(
     *         zapIn.doZeroExSwap.selector,
     *         address(token2),
     *         45e18,
     *         address(token0),
     *         42_745_690,
     *         address(zapIn),
     *         0x9a9DdE861b91B965DEAA0ce2D208DBE693e87fCb,
     *         block.timestamp + 1 days,
     *         hex"0d5f0e3b00000000000000000001901b67822177489fd6e28cdcb52e90f53d10740e01bd00000000000000000000000000000000000000000000000270801d946c94000000000000000000000000000000000000000000000000000000000000028c3f59000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000018000000000000000000000007cf803e8d82a50504180f417b8bc7a493c0a0503"
     *     );
     *
     *     // swap token1 from token2
     *     calls[1] = abi.encodeWithSelector(
     *         zapIn.doZeroExSwap.selector,
     *         address(token2),
     *         45e18,
     *         address(token1),
     *         42_104_745,
     *         address(zapIn),
     *         0x9a9DdE861b91B965DEAA0ce2D208DBE693e87fCb,
     *         block.timestamp + 1 days,
     *         hex"b80c2f09000000000000000000000000000000000000000000000000000000000001901b000000000000000000000000da10009cbd5d07dd0cecc66161fc93d7c9000da1000000000000000000000000fd086bc7cd5c481dcc9c85ebe478a1c0b69fcbb900000000000000000000000000000000000000000000000270801d946c94000000000000000000000000000000000000000000000000000000000000028277a80000000000000000000000000000000000000000000000000000000066742c5f0000000000000000000000000000000000000000000000000000000000000120000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000003c0000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000270801d946c940000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000001200000000000000000000000000000000000000000000000000000000000000160000000000000000000000000da10009cbd5d07dd0cecc66161fc93d7c9000da10000000000000000000000000000000000000000000000000000000000000001000000000000000000000000b06a44aa660537fb3f6482d65ff5b0c7d58dc1eb000000000000000000000000000000000000000000000000000000000000000100000000000000000000000015b9d20bcaa4f65d9004d2bebac4058445fd5285000000000000000000000000000000000000000000000000000000000000000100000000000000000000271015b9d20bcaa4f65d9004d2bebac4058445fd528500000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
     *     );
     *     // we need to encounter the fee deduction from okx and uniswap while depositing
     *     // Deposit Liquidity
     *     calls[2] = abi.encodeWithSelector(
     *         zapIn.zapIn.selector,
     *         ICLTBase.DepositParams({
     *             strategyId: strategyID,
     *             amount0Desired: amount0Desired,
     *             amount1Desired: amount1Desired,
     *             amount0Min: 0,
     *             amount1Min: 0,
     *             recipient: 0x9a9DdE861b91B965DEAA0ce2D208DBE693e87fCb
     *         }),
     *         token0,
     *         token1,
     *         true,
     *         true
     *     );
     *     bytes[] memory results = zapIn.multicall(calls);
     * }
     */
}
